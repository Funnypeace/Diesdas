<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NPC-Dialog — Simple • Seed-Lore → endlose Gespräche</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1520;
      --text: #e6eefc;
      --muted: #a2b1c7;
      --border: rgba(255, 255, 255, .14);
      --accent: #7c9cf5;
      --radius: 14px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f9fd;
        --panel: #ffffff;
        --text: #0b1220;
        --muted: #4b5563;
        --border: rgba(0, 0, 0, .1);
      }
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    header {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(124, 156, 245, .15), rgba(124, 156, 245, 0));
      backdrop-filter: saturate(130%) blur(8px);
      border-bottom: 1px solid var(--border);
    }
    h1 { font-size: 18px; margin: 0; }
    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: 320px 1fr;
      margin-top: 16px;
    }
    @media (max-width: 920px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
    }
    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin: 10px 0 6px;
    }
    input, textarea, select {
      width: 100%;
      background: rgba(255, 255, 255, .06);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      padding: 10px;
    }
    textarea { min-height: 110px; resize: vertical; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    button {
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    button.primary {
      border-color: transparent;
      background: linear-gradient(90deg, #7c9cf5, #22d3ee);
      color: #0b1220;
      font-weight: 700;
    }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    /* Chat */
    #log {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 65vh;
      overflow: auto;
    }
    .msg { display: flex; gap: 8px; }
    .msg .bubble {
      max-width: 78%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .msg.user { justify-content: flex-end; }
    .msg.user .bubble { background: rgba(255, 255, 255, .06); }
    .msg.npc .bubble {
      background: linear-gradient(180deg, rgba(124, 156, 245, .09), rgba(34, 211, 238, .06));
    }
    .hint { font-size: 12px; color: var(--muted); }
    .foot { margin-top: 8px; color: var(--muted); font-size: 12px; }
  </style>
  <!-- GoatCounter (optional, kann bleiben) -->
  <script async src="https://gc.zgo.at/count.js" data-goatcounter="https://funnypeace.goatcounter.com/count"></script>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px 16px">
      <h1>NPC-Dialog — Simple</h1>
      <div class="hint">Einzelne HTML • spricht mit <code>/api/groq</code></div>
    </div>
  </header>

  <div class="wrap grid">
    <!-- Linke Spalte: Seed & Persona -->
    <section class="card" aria-label="Seed & Persona">
      <label for="lore">Seed-Lore</label>
      <textarea id="lore" placeholder="Kurzbeschreibung, Rolle, Ort, Ziele, Stimmung …">Garruk Eisenbart ist der grimmige Nachtwächter von Dämmerhafen. Er liebt Ordnung, hasst Lärm und kennt jede Gasse. Im Schatten der alten Mauern rumort eine Schmugglerbande.</textarea>

      <div class="row">
        <div>
          <label for="name">Name (optional)</label>
          <input id="name" placeholder="z. B. Garruk Eisenbart" />
        </div>
        <div>
          <label for="role">Rolle (optional)</label>
          <input id="role" placeholder="z. B. Nachtwächter" />
        </div>
      </div>

      <label for="style">Stil/Ton</label>
      <select id="style">
        <option value="neutral" selected>Neutral</option>
        <option value="tavern">Taverne (herzlich)</option>
        <option value="guard">Wache (kurz angebunden)</option>
        <option value="mage">Magisch (mysteriös)</option>
        <option value="merchant">Händler:in (schlitzohrig)</option>
      </select>

      <div class="row" style="margin-top:10px">
        <button id="start" class="primary">Starten / Reset</button>
        <button id="copy" title="Persona in Zwischenablage kopieren">Persona kopieren</button>
      </div>

      <p class="foot">Tipp: <kbd>Enter</kbd> senden · <kbd>Shift+Enter</kbd> Zeilenumbruch</p>
    </section>

    <!-- Rechte Spalte: Chat -->
    <section class="card" aria-label="Chat">
      <div id="log" aria-live="polite"></div>
      <div class="row" style="margin-top:10px">
        <textarea id="input" placeholder="Spreche den NPC an…" style="min-height:40px;resize:vertical"></textarea>
        <button id="send">Senden</button>
      </div>
    </section>
  </div>

<script>
const $ = id => document.getElementById(id);
const log = $('log');
const input = $('input');
const lore = $('lore');
const nameEl = $('name');
const roleEl = $('role');
const styleEl = $('style');

let messages = [];
let busy = false;

const styles = {
  neutral: 'Du antwortest höflich und sachlich.',
  tavern: 'Du bist herzlich, warmherzig und redest wie ein Wirt oder eine Wirtin.',
  guard: 'Du bist knapp, direkt und etwas mürrisch wie eine Stadtwache.',
  mage: 'Du sprichst geheimnisvoll, weise und manchmal kryptisch.',
  merchant: 'Du bist geschäftstüchtig, schlitzohrig und immer auf Profit aus.'
};

function addMessage(text, isUser) {
  const msg = document.createElement('div');
  msg.className = `msg ${isUser ? 'user' : 'npc'}`;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  msg.appendChild(bubble);
  log.appendChild(msg);
  log.scrollTop = log.scrollHeight;
}

function buildPrompt() {
  const persona = lore.value.trim();
  const charName = nameEl.value.trim();
  const charRole = roleEl.value.trim();
  const styleDesc = styles[styleEl.value] || styles.neutral;

  let prompt = 'Du bist ein Charakter in einem Rollenspiel. ';
  if (persona) prompt += persona + ' ';
  if (charName) prompt += `Du heißt ${charName}. `;
  if (charRole) prompt += `Du bist ${charRole}. `;
  prompt += styleDesc + ' Antworte kurz und bleibe im Charakter. Stelle gelegentlich Gegenfragen.';

  return prompt;
}

function setBusy(v) {
  busy = v;
  $('send').disabled = v;
  input.disabled = v;
}

async function sendMessage() {
  if (busy) return;
  const userText = input.value.trim();
  if (!userText) return;

  input.value = '';
  addMessage(userText, true);

  const systemPrompt = buildPrompt();
  messages.push({ role: 'user', content: userText });

  setBusy(true);
  try {
    const response = await fetch('/api/groq', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'chat',
        model: 'llama-3.3-70b-versatile',
        temperature: 0.8,
        max_tokens: 200,
        // Dein Server erwartet direkt die Messages (kein OpenAI-choices-Objekt)
        messages: [{ role: 'system', content: systemPrompt }, ...messages]
      })
    });

    const data = await response.json().catch(() => ({}));

    if (!response.ok) {
      console.error('Groq API error:', response.status, data);
      addMessage(`Fehler beim Laden der Antwort. (${response.status})`, false);
      return;
    }

    if (data && data.error) {
      console.error('API logical error:', data);
      addMessage(`Fehler: ${data.error}${data.details ? ' – ' + data.details : ''}`, false);
      return;
    }

    const npcText = (data && data.content) ? String(data.content).trim() : '';
    messages.push({ role: 'assistant', content: npcText || '' });
    addMessage(npcText || 'Keine Antwort erhalten.', false);

  } catch (error) {
    console.error('Fetch failed:', error);
    addMessage('Fehler: Verbindung zum Server fehlgeschlagen.', false);
  } finally {
    setBusy(false);
    input.focus();
  }
}

function startConversation() {
  messages = [];
  log.innerHTML = '';
  addMessage('Gespräch gestartet. Spreche den NPC an!', false);
}

function copyPersona() {
  const persona = buildPrompt();
  navigator.clipboard.writeText(persona).then(() => {
    const btn = $('copy');
    const orig = btn.textContent;
    btn.textContent = 'Kopiert!';
    setTimeout(() => btn.textContent = orig, 1000);
  });
}

// Events
$('start').addEventListener('click', startConversation);
$('send').addEventListener('click', sendMessage);
$('copy').addEventListener('click', copyPersona);
input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Init
startConversation();
</script>
</body>
</html>
