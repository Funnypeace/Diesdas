<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News‑Zusammenfassung (Firecrawl + Groq)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .prose p { margin: 0.4rem 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
  <!-- GoatCounter -->
  <script async src="https://gc.zgo.at/count.js" data-goatcounter="https://funnypeace.goatcounter.com/count"></script>
  <!-- End GoatCounter -->
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-3xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">News‑Zusammenfassung: Firecrawl → Groq</h1>
      <p class="text-sm text-slate-600">Dieses Frontend nutzt <span class="font-semibold">/api/groq</span> (serverseitig) – keine Client‑Keys, kein Demo‑Modus.</p>
    </header>
    <section class="bg-white rounded-2xl shadow p-4 mb-4">
      <label class="block text-sm font-medium mb-2">Quellen (eine Domain oder URL pro Zeile)</label>
      <textarea id="sources" class="w-full h-32 rounded-xl border border-slate-200 p-3 text-sm mono" placeholder="https://www.tagesschau.de\nhttps://www.zeit.de/index\nspiegel.de/politik"></textarea>
      <label class="block text-sm font-medium mt-4 mb-2">Themen/Keywords (optional)</label>
      <input id="keywords" class="w-full rounded-xl border border-slate-200 p-3 text-sm" placeholder="wirtschaft, politik, energie …" />
      <div class="flex items-center gap-3 mt-4">
        <button id="btnSummarize" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">Zusammenfassen (3 Sätze)</button>
        <button id="btnClear" class="px-4 py-2 rounded-xl border">Zurücksetzen</button>
      </div>
      <p class="text-xs text-slate-500 mt-2">Server‑Route: <span class="mono">/api/groq</span>. Die Route übernimmt Firecrawl‑Suche/Scrapes serverseitig (wenn ein Query übergeben wird) und lässt Groq zusammenfassen.</p>
    </section>
    <section class="bg-white rounded-2xl shadow p-4 mb-4">
      <h2 class="font-semibold mb-2">Zusammenfassung</h2>
      <div id="summary" class="prose text-sm text-slate-800 bg-slate-50 rounded-xl p-3 min-h-[6rem]"></div>
    </section>
    <section class="bg-white rounded-2xl shadow p-4">
      <h3 class="font-semibold mb-2">Protokoll</h3>
      <div id="log" class="mono text-xs whitespace-pre-wrap bg-slate-50 rounded-xl p-3 h-40 overflow-auto"></div>
    </section>
  </main>
  <script>
    // ----------------------
    // Helpers
    // ----------------------
    const $ = (id) => document.getElementById(id);
    const log = (msg) => { const el = $("log"); el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`; el.scrollTop = el.scrollHeight; };
    
    function parseUrls(lines) {
      const urls = [];
      for (let raw of lines) {
        if (!raw) continue;
        raw = raw.trim();
        try {
          // Vollständige URL beibehalten, nur Protokoll hinzufügen falls nötig
          const fullUrl = raw.startsWith('http') ? raw : ('https://' + raw);
          const u = new URL(fullUrl);
          urls.push(fullUrl); // Komplette URL verwenden
        } catch (e) {
          log(`Ungültige URL übersprungen: ${raw}`);
        }
      }
      return urls;
    }

    // ----------------------
    // Main Logic
    // ----------------------
    $("btnSummarize").addEventListener("click", async () => {
      const sourcesText = $("sources").value.trim();
      const keywords = $("keywords").value.trim();
      
      if (!sourcesText) {
        alert("Bitte geben Sie mindestens eine Quelle ein.");
        return;
      }

      const lines = sourcesText.split("\n").filter(l => l.trim());
      const urls = parseUrls(lines);
      
      if (urls.length === 0) {
        alert("Keine gültigen URLs gefunden.");
        return;
      }

      log(`Starte Zusammenfassung für ${urls.length} URL(s):`);
      urls.forEach(url => log(`  - ${url}`));
      $("summary").innerHTML = "<em>Lädt...</em>";
      $("btnSummarize").disabled = true;
      
      try {
        // Backend erwartet 'query' für Firecrawl-Suche und 'sources' für direktes Scraping
        const payloads = [
          // Option 1: sources Array + query (direktes Scraping + Suchaktivierung)
          {
            sources: urls,
            query: keywords || "nachrichten",
            action: "news_summary"
          },
          // Option 2: Nur query für Firecrawl-Suche mit site-Filter
          {
            query: `${keywords || "nachrichten"} site:${urls.map(url => new URL(url).hostname.replace(/^www\./, '')).join(' OR site:')}`,
            action: "news_summary"
          },
          // Option 3: Query ohne site-Filter (allgemeine Suche)
          {
            query: keywords || "nachrichten",
            action: "news_summary"
          }
        ];
        
        for (let i = 0; i < payloads.length; i++) {
          const payload = payloads[i];
          log(`Versuche Payload-Format ${i + 1}: ${JSON.stringify(payload, null, 2)}`);
          
          const response = await fetch("/api/groq", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            log(`HTTP ${response.status}: ${response.statusText}`);
            if (i === payloads.length - 1) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            continue;
          }
          
          const data = await response.json();
          log(`Antwort erhalten: ${JSON.stringify(data, null, 2)}`);
          
          // Prüfen ob das Backend Daten verarbeitet hat
          if (data.debug && (data.debug.scrapedCount > 0 || (data.debug.firecrawlUsed && data.debug.targets?.length > 0))) {
            log(`✅ Erfolgreich mit Payload-Format ${i + 1} (firecrawlUsed: ${data.debug.firecrawlUsed}, scrapedCount: ${data.debug.scrapedCount})`);
            
            if (data.content && data.content !== 'Keine relevanten Nachrichten gefunden. Es liegen keine Eingangsdaten vor, um eine Zusammenfassung zu erstellen.') {
              $("summary").innerHTML = `<p>${data.content}</p>`;
              log("Zusammenfassung erfolgreich erstellt.");
              return;
            }
          } else if (i < payloads.length - 1) {
            log(`❌ Payload-Format ${i + 1} funktioniert nicht (firecrawlUsed: ${data.debug?.firecrawlUsed}, scrapedCount: ${data.debug?.scrapedCount})`);
            continue;
          }
          
          // Fallback wenn Content vorhanden aber Standard-Fehlermeldung
          if (data.content && data.content !== 'Keine relevanten Nachrichten gefunden. Es liegen keine Eingangsdaten vor, um eine Zusammenfassung zu erstellen.') {
            $("summary").innerHTML = `<p>${data.content}</p>`;
            log("Content erhalten (Fallback).");
            return;
          }
          
          if (i === payloads.length - 1) {
            $("summary").innerHTML = "<em>Keine Zusammenfassung erhalten.</em>";
            log("Warnung: Keine verwendbare Antwort von allen Payload-Formaten.");
          }
        }
        
      } catch (error) {
        log(`Fehler: ${error.message}`);
        $("summary").innerHTML = `<em>Fehler: ${error.message}</em>`;
      } finally {
        $("btnSummarize").disabled = false;
      }
    });

    $("btnClear").addEventListener("click", () => {
      $("sources").value = "";
      $("keywords").value = "";
      $("summary").innerHTML = "";
      $("log").textContent = "";
      log("Felder zurückgesetzt.");
    });

    // Initial log
    log("News-Zusammenfassung bereit.");
  </script>
</body>
</html>
