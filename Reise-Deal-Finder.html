<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reise‑Deal‑Finder • Groq + Firecrawl (serverseitig)</title>
  <meta name="description" content="Findet Flash‑Deals für Budget‑Reisende. Nutzt Groq (Llama) zum Zusammenfassen und Firecrawl serverseitig via /api/groq. Strikte Echt‑Daten‑Policy (keine Demos)." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { boxShadow: { smooth: '0 12px 30px -12px rgba(0,0,0,.25)' } } } };
  </script>
  <style>
    html, body { height: 100%; }
    .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,.75); }
    .spinner { width: 18px; height: 18px; border: 3px solid #e5e7eb; border-top-color: #111827; border-radius: 50%; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 to-white text-gray-900">
  <!-- Header -->
  <header class="sticky top-0 z-40 glass border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-gray-900 text-white grid place-content-center font-semibold">€</div>
      <div>
        <h1 class="text-lg font-semibold leading-none">Reise‑Deal‑Finder</h1>
        <p class="text-xs text-gray-600">Groq + Firecrawl (serverseitig) • Budget • Flash‑Deals • Nachhaltig • Nur echte Daten</p>
      </div>
      <a href="https://vercel.com" target="_blank" rel="noopener noreferrer" class="ml-auto text-xs text-gray-600 hover:text-gray-900 underline">Vercel</a>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 pt-6 pb-28">
    <!-- Search Card -->
    <section class="bg-white shadow-smooth rounded-2xl p-4 md:p-6">
      <div class="grid md:grid-cols-5 gap-3">
        <div class="md:col-span-2 grid gap-3">
          <label class="block text-sm font-medium">Abflug (Stadt/Code)
            <input id="from" class="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="z. B. HAM, BER, MUC" />
          </label>
          <label class="block text-sm font-medium">Zielregion
            <input id="region" class="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="Europa, Skandinavien, Südeuropa…" />
          </label>
          <label class="block text-sm font-medium">Budget (max €)
            <input id="budget" type="range" min="50" max="500" step="10" value="200" class="mt-2 w-full" oninput="budgetOut.textContent=this.value+' €'" />
            <div class="text-xs text-gray-600 mt-1">Aktuell: <span id="budgetOut" class="font-semibold">200 €</span></div>
          </label>
        </div>
        <div class="md:col-span-2 grid gap-3">
          <label class="block text-sm font-medium">Reisezeitraum
            <input id="dates" class="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="z. B. nächstes Wochenende, 23–25.08, flexibel" />
          </label>
          <label class="block text-sm font-medium">Nachhaltigkeit
            <select id="eco" class="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900">
              <option value="auto">Mix</option>
              <option value="prefer-low">Low‑CO₂ bevorzugt</option>
              <option value="strict-low">Nur Low‑CO₂</option>
            </select>
          </label>
          <label class="flex items-center gap-2 text-sm font-medium select-none mt-1">
            <input id="nonstop" type="checkbox" class="h-4 w-4 rounded border-gray-300" />
            <span>Nur Nonstop / Direktverbindungen</span>
          </label>
          <label class="block text-sm font-medium">Aktivitäten (optional)
            <input id="interests" class="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="Museen, Wandern, Food…" />
          </label>
        </div>
        <div class="md:col-span-1 grid content-start gap-2">
          <button id="btnSearch" class="mt-6 inline-flex items-center justify-center gap-2 bg-gray-900 text-white rounded-xl px-4 py-2 hover:opacity-90 active:opacity-95">
            Deals finden
            <div id="loadingIcon" class="hidden spinner"></div>
          </button>
        </div>
      </div>
      <p class="mt-3 text-[12px] text-gray-500">Hinweis: Es werden <strong>nur echte Angebote</strong> mit gültiger Quelle/URL angezeigt. Wenn keine Daten vorliegen (z. B. wegen Ratenlimits), erscheint eine Fehlermeldung.</p>
    </section>

    <!-- Results -->
    <section id="results" class="mt-6 grid gap-4"></section>
  </main>

  <footer class="fixed bottom-0 inset-x-0 glass border-t">
    <div class="max-w-6xl mx-auto px-4 py-3 text-xs text-gray-600 flex flex-wrap items-center gap-2">
      <span>Backend: <code class="px-1 py-0.5 bg-gray-100 rounded">/api/groq</code> • Action <code>summarize_deals</code> (mit <code>query</code>)</span>
      <span class="text-gray-300">•</span>
      <span>Chat‑Frontends nutzen <code>action: "chat"</code> (ohne Firecrawl)</span>
    </div>
  </footer>

  <!-- Deal Card Template -->
  <template id="dealCardTpl">
    <article class="p-4 rounded-2xl bg-white shadow-smooth grid gap-3">
      <div class="flex items-start gap-3">
        <div class="h-10 w-10 rounded-xl bg-gray-900 text-white grid place-content-center font-bold">€</div>
        <div class="min-w-0">
          <h3 class="font-semibold text-lg leading-tight line-clamp-2"></h3>
          <p class="text-sm text-gray-600 line-clamp-2"></p>
        </div>
        <div class="ml-auto text-right">
          <div class="text-xl font-semibold price"></div>
          <div class="text-[11px] text-gray-500 eco"></div>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 text-xs">
        <span class="px-2 py-1 rounded-lg bg-gray-100 date"></span>
        <span class="px-2 py-1 rounded-lg bg-gray-100 origin"></span>
        <span class="px-2 py-1 rounded-lg bg-gray-100 dest"></span>
        <span class="px-2 py-1 rounded-lg bg-gray-100 provider"></span>
      </div>
      <div class="flex gap-2">
        <a class="book btn inline-flex items-center justify-center gap-1 px-3 py-2 rounded-xl bg-gray-900 text-white hover:opacity-90" target="_blank" rel="noopener noreferrer">Jetzt buchen</a>
        <button class="explain btn inline-flex items-center justify-center gap-1 px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-50">Warum dieser Deal?</button>
      </div>
      <details class="explainBox hidden bg-gray-50 rounded-xl p-3 text-sm text-gray-800"></details>
    </article>
  </template>

  <script>
    // ---------- Helpers ----------
    const $ = (sel, el=document) => el.querySelector(sel);
    const resultsEl = $('#results');
    const tplDeal = $('#dealCardTpl');

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function parseJSON(txt){
      try { return JSON.parse(txt); } catch(e) {
        const m = String(txt||'').match(/[\[{][\s\S]*[\]}]/);
        if (m) { try { return JSON.parse(m[0]); } catch(e2){} }
        return [];
      }
    }

    function ecoLabel(eco){
      if(eco==='strict-low') return 'Low‑CO₂ only';
      if(eco==='prefer-low') return 'Low‑CO₂ bevorzugt';
      return 'Mix';
    }

    function toggleLoading(on){
      const icon = $('#loadingIcon');
      $('#btnSearch').disabled = !!on;
      icon.classList.toggle('hidden', !on);
    }

    function showError(title, details){
      resultsEl.innerHTML = `
        <div class="p-4 md:p-5 rounded-2xl bg-red-50 ring-1 ring-red-200 text-red-800">
          <div class="font-semibold mb-1">${escapeHtml(title)}</div>
          <div class="text-sm">${escapeHtml(details || '')}</div>
          <ul class="mt-2 text-[12px] list-disc pl-5">
            <li>Filter anpassen (Budget/Region/Nonstop)</li>
            <li>Später erneut versuchen (Rate Limits möglich)</li>
          </ul>
        </div>`;
    }

    // Validiere echte Deals: URL Pflicht, kein "demo" im Text, Preis Zahl
    function filterRealDeals(arr){
      return (arr||[]).filter(d => {
        const urlOk = typeof d?.url === 'string' && /^https?:\/\//i.test(d.url);
        const priceOk = typeof d?.price === 'number' && isFinite(d.price);
        const notDemo = !/demo/i.test(String(d?.desc||'') + ' ' + String(d?.title||''));
        return urlOk && priceOk && notDemo;
      });
    }

    // ---------- Backend calls ----------
    async function callGroq(body){
      const res = await fetch('/api/groq', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const text = await res.text();
        throw new Error('Groq API Fehler: '+res.status+' '+text);
      }
      return res.json();
    }

    async function explainDeal(d){
      const messages = [
        { role: 'system', content: 'Du erklärst Deals prägnant in 2–3 Sätzen und gibst 2 konkrete Tipps.' },
        { role: 'user', content: `Erkläre kurz, warum dieser Deal passt und gib 2 Tipps.\n${JSON.stringify(d)}` }
      ];
      const r = await callGroq({ messages, action: 'explain_deal' });
      return r.content || '—';
    }

    // ---------- Rendering ----------
    function renderDeals(deals){
      resultsEl.innerHTML = '';
      if(!deals?.length){
        showError('Keine echten Daten gefunden', 'Es wurden keine validen Angebote mit Quelle/URL geliefert.');
        return;
      }
      const frag = document.createDocumentFragment();
      for(const d of deals){
        const node = tplDeal.content.cloneNode(true);
        node.querySelector('h3').textContent = d.title || '';
        node.querySelector('p').textContent = d.desc || '';
        node.querySelector('.price').textContent = d.price ? d.price + ' €' : '';
        node.querySelector('.eco').textContent = d.eco || '';
        node.querySelector('.date').textContent = d.date || '';
        node.querySelector('.origin').textContent = d.origin || '';
        node.querySelector('.dest').textContent = d.dest || '';
        node.querySelector('.provider').textContent = d.provider || '';
        node.querySelector('.book').href = d.url || '#';
        node.querySelector('.explain').addEventListener('click', async (e)=>{
          const box = e.target.closest('article').querySelector('.explainBox');
          box.classList.remove('hidden');
          box.textContent = 'Lade Erklärung…';
          try{ box.textContent = await explainDeal(d); } catch{ box.textContent = 'Konnte Erklärung nicht laden.'; }
        });
        frag.appendChild(node);
      }
      resultsEl.appendChild(frag);
    }

    // ---------- Search handler ----------
    $('#btnSearch').addEventListener('click', async () => {
      const from = $('#from').value.trim() || 'HAM';
      const region = $('#region').value.trim() || 'Europa';
      const budget = parseInt($('#budget').value, 10) || 200;
      const dates = $('#dates').value.trim() || 'Wochenende';
      const eco = $('#eco').value;
      const interests = $('#interests').value.trim();
      const nonstop = $('#nonstop').checked;

      toggleLoading(true);
      try{
        const searchQuery = [
          'site:skyscanner.net',
          'site:kiwi.com',
          'site:ryanair.com',
          'site:easyjet.com',
          'site:trainline.com'
        ].join(' OR ') + ` weekend deals ${from} ${region} under ${budget} EUR` + (nonstop ? ' nonstop OR "non-stop" OR direct OR "no layover"' : '');

        // Prompt an Groq – Firecrawl wird serverseitig anhand von "query" genutzt
        const prompt = [
          `Ziel: Finde 5–8 konkrete Flash‑Deals (Flug/Bahn/Hotel/Aktivität) für Budget‑Reisende.`,
          `Abflug: ${from}. Region: ${region}. Zeitraum: ${dates}. Budget: <= ${budget} EUR. Eco: ${ecoLabel(eco)}. Interessen: ${interests || '—'}.`,
          nonstop ? `Strenge Vorgabe: Nur Nonstop/Direktverbindungen; verwerfe Angebote mit Umstieg(en).` : `Nonstop nicht erforderlich.`,
          `Format: JSON‑Array mit {title, desc, price, date, origin, dest, provider, url, eco}.`,
          `Nur echte, verlinkbare Angebote (URL Pflicht). Keine fiktiven Beispiele.`
        ].join('\n');

        const resp = await callGroq({
          messages: [{ role: 'user', content: prompt }],
          action: 'summarize_deals',
          query: searchQuery
        });

        let deals = parseJSON(resp.content);
        deals = filterRealDeals(deals);

        // zusätzliche Laufzeit-Filter: wenn Nonstop gefordert, filtern nach Hinweisen im Text
        if (nonstop) {
          deals = deals.filter(d => /nonstop|non-stop|direct|direkt/i.test(`${d?.desc||''} ${d?.title||''}`));
        }

        if(!Array.isArray(deals) || deals.length === 0){
          showError('Keine echten Daten gefunden', 'Die Anfrage lieferte keine validen Nonstop‑Angebote innerhalb deines Budgets.');
          return;
        }

        renderDeals(deals);
      } catch(err){
        console.error(err);
        showError('Fehler beim Laden', err.message);
      } finally {
        toggleLoading(false);
      }
    });
  </script>
</body>
</html>
