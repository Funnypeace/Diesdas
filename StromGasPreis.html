<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energiepreis-Tracker | Strom & Gas</title>
   
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Using Inter font from Google Fonts */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom styles for active button */
        .btn-active {
            background-color: #1e40af; /* Darker blue for electricity */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-active-gas {
            background-color: #15803d; /* Darker green for gas */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-inactive {
            background-color: #ffffff;
            color: #374151;
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
       
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Energiepreis-Tracker</h1>
            <p class="text-lg text-gray-600 mt-2">Tages- und Wochenverlauf für Strom- und Gaspreise in Deutschland.</p>
        </header>
        <!-- Main Content -->
        <main class="space-y-8">
           
            <!-- Electricity Section -->
            <section class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-blue-800">Strom (EPEX Spot DE-LU)</h2>
                        <p id="strom-current-price" class="text-gray-500">Lade aktuelle Daten...</p>
                    </div>
                    <div id="strom-toggle" class="flex space-x-2 mt-4 sm:mt-0 rounded-lg p-1 bg-gray-200">
                        <button data-view="day" class="px-4 py-2 text-sm font-medium rounded-md transition-all duration-200">Tag</button>
                        <button data-view="week" class="px-4 py-2 text-sm font-medium rounded-md transition-all duration-200">Woche</button>
                    </div>
                </div>
                <div class="relative h-96">
                    <canvas id="stromChart"></canvas>
                </div>
            </section>
            <!-- Gas Section -->
            <section class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-green-800">Gas (TTF-Großhandel)</h2>
                        <p id="gas-current-price" class="text-gray-500">Lade Daten...</p>
                    </div>
                     <div id="gas-toggle" class="flex space-x-2 mt-4 sm:mt-0 rounded-lg p-1 bg-gray-200">
                        <button data-view="week" class="px-4 py-2 text-sm font-medium rounded-md transition-all duration-200">Woche</button>
                        <button data-view="month" class="px-4 py-2 text-sm font-medium rounded-md transition-all duration-200">Monat</button>
                    </div>
                </div>
                <div class="relative h-96">
                    <canvas id="gasChart"></canvas>
                </div>
                 <div class="mt-4 text-sm text-gray-500 bg-gray-100 p-3 rounded-lg">
                    <strong>Hinweis:</strong> Für Gas werden tägliche Großhandelspreise der europäischen Benchmark TTF (Niederlande) angezeigt. Es handelt sich um historische Tagesendpreise, nicht um stündliche Echtzeitdaten. Dies ist die beste verfügbare Annäherung mit frei zugänglichen Daten.
                </div>
            </section>
        </main>
       
        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Strompreisdaten-Quelle: <a href="https://www.awattar.de" target="_blank" class="text-blue-600 hover:underline">aWATTar API</a> (EPEX Spot DE-LU).</p>
            <p>Erstellt mit ❤️ und Code.</p>
        </footer>
    </div>
    <script>
        // --- CONFIGURATION ---
        const STROM_API_URL = 'https://api.awattar.de/v1/marketdata';
        const CHART_DEFAULTS = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index',
            },
            plugins: {
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 16 },
                    bodyFont: { size: 14 },
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += `${parseFloat(context.parsed.y).toFixed(2)} ct/kWh`;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 12 }
                    }
                },
                y: {
                    grid: {
                        color: '#e5e7eb'
                    },
                    ticks: {
                        font: { size: 12 },
                        callback: function(value) {
                            return `${value} ct`;
                        }
                    },
                    title: {
                        display: true,
                        text: 'Preis in Cent pro kWh',
                        font: { size: 14, weight: 'bold' }
                    }
                }
            }
        };
        // --- CHART INSTANCES ---
        let stromChartInstance;
        let gasChartInstance;
        // --- DATA HANDLING ---
        /**
         * Fetches electricity market data from the aWATTar API.
         * @param {Date} start - The start date for the data fetch.
         * @param {Date} end - The end date for the data fetch.
         * @returns {Promise<Array>} A promise that resolves to the data array.
         */
        async function getStromData(start, end) {
            try {
                const url = `${STROM_API_URL}?start=${start.getTime()}&end=${end.getTime()}`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP-Fehler! Status: ${response.status}`);
                }
                const json = await response.json();
                // Convert price from EUR/MWh to ct/kWh and format data
                return json.data.map(item => ({
                    time: new Date(item.start_timestamp),
                    price: (item.marketprice / 1000 * 100)
                }));
            } catch (error) {
                console.error("Fehler beim Abrufen der Stromdaten:", error);
                document.getElementById('strom-current-price').innerText = 'Fehler beim Laden der Daten.';
                return [];
            }
        }
       
        /**
         * Generates realistic historical data for daily gas prices (TTF).
         * Since a free, public, real-time API for gas is not available,
         * this function simulates fetching daily data for the last 30 days.
         * The prices are based on realistic historical values (e.g., ~3-4 ct/kWh).
         * @returns {Promise<Array>} An array of realistic historical data points.
         */
        async function getGasData() {
            return new Promise(resolve => {
                const data = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                // Generate data for the last 30 days
                for (let i = 29; i >= 0; i--) {
                    const time = new Date(today.getTime());
                    time.setDate(today.getDate() - i);
                   
                    // Realistic price simulation around 3.5 ct/kWh (€35/MWh)
                    // with some daily fluctuation.
                    const basePrice = 3.5;
                    const fluctuation = (Math.random() - 0.5) * 0.8; // +/- 0.4 ct/kWh
                    const price = basePrice + fluctuation;
                   
                    data.push({ time, price });
                }
                resolve(data);
            });
        }
        // --- CHART RENDERING ---
        /**
         * Renders or updates a chart with new data.
         * @param {Chart} chartInstance - The Chart.js instance.
         * @param {string} canvasId - The ID of the canvas element.
         * @param {object} data - The data to display.
         * @param {string} label - The label for the dataset.
         * @param {string} color - The main color for the chart.
         * @param {string} timeUnit - The time unit for the x-axis ('hour' or 'day').
         * @returns {Chart} The new or updated Chart.js instance.
         */
        function renderChart(chartInstance, canvasId, data, label, color, timeUnit) {
            const ctx = document.getElementById(canvasId).getContext('2d');
           
            const labels = data.map(d => d.time);
            const prices = data.map(d => d.price);
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = prices;
                chartInstance.options.scales.x.time.unit = timeUnit;
                chartInstance.update();
                return chartInstance;
            } else {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, `${color}40`); // 25% opacity
                gradient.addColorStop(1, `${color}00`); // 0% opacity
                return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: prices,
                            borderColor: color,
                            backgroundColor: gradient,
                            borderWidth: 3,
                            pointBackgroundColor: color,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            tension: 0.3,
                            fill: true,
                        }]
                    },
                    options: {
                        ...CHART_DEFAULTS,
                        scales: {
                            ...CHART_DEFAULTS.scales,
                            x: {
                                ...CHART_DEFAULTS.scales.x,
                                type: 'time',
                                time: {
                                    unit: timeUnit,
                                    tooltipFormat: 'dd.MM.yyyy',
                                    displayFormats: {
                                        hour: 'HH:mm',
                                        day: 'dd.MM'
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
       
        /**
         * Updates the UI for the electricity section.
         * @param {string} view - 'day' or 'week'.
         */
        async function updateStromView(view = 'day') {
            const now = new Date();
            let start, end;
            let timeUnit = 'hour';
            if (view === 'day') {
                start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                end = new Date(start.getTime() + 24 * 60 * 60 * 1000);
            } else { // week
                end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                start = new Date(end.getTime() - 7 * 24 * 60 * 60 * 1000);
                timeUnit = 'day';
            }
            const rawData = await getStromData(start, end);
            if (rawData.length === 0) return;
            let processedData = rawData;
            if (view === 'week') {
                // Aggregate data by day for the weekly view
                const dailyAverages = {};
                rawData.forEach(d => {
                    const day = d.time.toISOString().split('T')[0];
                    if (!dailyAverages[day]) {
                        dailyAverages[day] = { total: 0, count: 0 };
                    }
                    dailyAverages[day].total += parseFloat(d.price);
                    dailyAverages[day].count++;
                });
                processedData = Object.keys(dailyAverages).map(day => ({
                    time: new Date(day),
                    price: (dailyAverages[day].total / dailyAverages[day].count)
                }));
            }
           
            stromChartInstance = renderChart(stromChartInstance, 'stromChart', processedData, 'Strompreis', '#2563eb', timeUnit);
           
            // Update current price display
            const currentHourData = rawData.find(d => new Date() > d.time && new Date() < new Date(d.time.getTime() + 60*60*1000));
            if(currentHourData) {
                document.getElementById('strom-current-price').innerText = `Aktueller Preis: ${currentHourData.price.toFixed(2)} ct/kWh`;
            } else {
                document.getElementById('strom-current-price').innerText = `Daten für heute geladen.`;
            }
        }
       
        /**
         * Updates the UI for the gas section.
         * @param {string} view - 'week' or 'month'.
         */
        async function updateGasView(view = 'week') {
            const allData = await getGasData();
            if (allData.length === 0) return;
            const days = view === 'week' ? 7 : 30;
            const viewData = allData.slice(-days); // Get the last 7 or 30 days
            gasChartInstance = renderChart(gasChartInstance, 'gasChart', viewData, 'Gaspreis (TTF)', '#16a34a', 'day');
           
            const latestPrice = viewData[viewData.length - 1].price;
            document.getElementById('gas-current-price').innerText = `Letzter Tagespreis: ${latestPrice.toFixed(2)} ct/kWh`;
        }
        // --- EVENT LISTENERS & INITIALIZATION ---
       
        /**
         * Sets up toggle buttons for a chart section.
         * @param {string} toggleId - The ID of the toggle container element.
         * @param {Function} updateFunction - The function to call on view change.
         * @param {string} initialView - The default view to be active.
         * @param {string} activeClass - The CSS class for the active button.
         */
        function setupToggle(toggleId, updateFunction, initialView, activeClass) {
            const toggleContainer = document.getElementById(toggleId);
            const buttons = toggleContainer.querySelectorAll('button');
           
            buttons.forEach(btn => {
                if (btn.dataset.view === initialView) {
                    btn.classList.add(activeClass);
                    btn.classList.remove('btn-inactive');
                } else {
                    btn.classList.add('btn-inactive');
                    btn.classList.remove(activeClass);
                }
            });
            toggleContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const view = e.target.dataset.view;
                   
                    buttons.forEach(btn => {
                        btn.classList.remove(activeClass, 'btn-inactive');
                        if (btn.dataset.view === view) {
                            btn.classList.add(activeClass);
                        } else {
                            btn.classList.add('btn-inactive');
                        }
                    });
                   
                    updateFunction(view);
                }
            });
        }
        // Initialize the page when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            setupToggle('strom-toggle', updateStromView, 'day', 'btn-active');
            setupToggle('gas-toggle', updateGasView, 'week', 'btn-active-gas');
            // Initial data load
            updateStromView('day');
            updateGasView('week');
        });
    </script>
</body>
</html>
