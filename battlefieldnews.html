<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Battlefield 6 Patch-Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121822;
      --muted: #8aa0b6;
      --text: #e7f0ff;
      --accent: #6ab0ff;
      --good: #2ecc71;
      --bad: #ff6b6b;
      --chip: #1a2330;
      --border: #223045;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    html, body {
      margin: 0;
      background: linear-gradient(180deg, #0b0f14, #0e141d);
      color: var(--text);
      font: 16px/1.45 system-ui, Segoe UI, Roboto, Ubuntu, Helvetica Neue, Arial;
    }
    header {
      padding: 28px 20px 8px;
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 { margin: 0 0 6px; font-size: 28px; }
    .muted { color: var(--muted); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px 20px 40px; }
    .controls {
      display: grid;
      grid-template-columns: 1fr 150px 150px 160px;
      gap: 10px;
      margin: 12px 0 18px;
    }
    input, select {
      background: #0f1722;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 14px;
      margin: 10px 0;
      box-shadow: var(--shadow);
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      background: var(--chip);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 15px;
    }
    .hint {
      color: var(--muted);
      font-size: 14px;
      margin: 24px 0 4px 0;
    }
    .details {
      margin-top: 22px;
      word-break: break-all;
    }
    .good { color: var(--good); }
    .bad { color: var(--bad); }
    button {
      background: var(--accent);
      color: #fff;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      padding: 10px 22px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { filter: brightness(1.08); }
    pre {
      background: #12161f;
      color: #cbe1ff;
      border-radius: 9px;
      padding: 8px 10px;
      margin: 6px 0 0 0;
      font-size: 14px;
      max-height: 320px;
      overflow: auto;
    }
    summary {
      cursor: pointer;
      font-weight: bold;
      margin: 6px 0 3px 0;
    }
    @media (max-width: 900px) {
      .wrap, header { padding: 14px; }
      .controls { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 700px) {
      .controls { display: block; }
      .wrap, header { padding: 8px; }
      .card { padding: 8px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Battlefield 6 Patch-Tracker</h1>
    <div class="muted">Live-Daten von der offiziellen EA Patchnote-Seite &bull; Automatische Updates alle 60 Minuten</div>
  </header>
  <div class="wrap">
    <div class="row controls">
      <input id="search" type="text" placeholder="Suche Version, Waffe, Notizen...">
      <select id="filter">
        <option value="">Alle √Ñnderungen</option>
        <option value="Buffs">Nur Buffs</option>
        <option value="Nerfs">Nur Nerfs</option>
      </select>
      <input type="date" id="fromDate">
      <input type="date" id="toDate">
    </div>
    <div class="card" id="main">
      <div class="row" style="margin-bottom: 12px;">
        <div id="statusText">
          <span class="muted">Aktualisiert: <span id="datetime">--:--:--</span> &bull; <span id="patchStatus">Lade Patch-Daten von EA...</span></span>
        </div>
        <button id="reloadBtn">Jetzt aktualisieren</button>
      </div>
      <div id="patchList" class="chips"></div>
    </div>
    <div class="details card">
      <strong>‚ÑπÔ∏è Debug-Informationen & Rohdaten</strong>
      <details open>
        <summary>Letztes Debug-Objekt</summary>
        <pre id="debug"></pre>
      </details>
      <details>
        <summary>Letzte gesamte API-Antwort</summary>
        <pre id="apiRaw"></pre>
      </details>
      <details>
        <summary>Alle Fehler / Exceptions</summary>
        <pre id="errorLog"></pre>
      </details>
      <details>
        <summary>Letzter Patch-Response (JSON, gek√ºrzt)</summary>
        <pre id="patchRaw"></pre>
      </details>
    </div>
    <div class="details card">
      <strong>üîß Wie funktioniert das?</strong>
      <div class="hint">
        Diese Seite ruft <code>/api/groq2</code> auf und √ºbergibt die <b>offizielle EA News URL</b>.<br>
        Firecrawl scrapt die Patch-Notes von <b>EA</b>, Groq (LLaMA) extrahiert strukturierte Daten (Version, Waffen-Changes, etc.).<br>
        Automatisches Reload alle 60 Minuten f√ºr frische Daten.<br>
        Komplett serverless √ºber Vercel Functions.
      </div>
    </div>
  </div>
  <script>
    const statusText = document.getElementById("statusText");
    const patchStatus = document.getElementById("patchStatus");
    const datetime = document.getElementById("datetime");
    const reloadBtn = document.getElementById("reloadBtn");
    const debugEl = document.getElementById("debug");
    const apiRawEl = document.getElementById("apiRaw");
    const errorLogEl = document.getElementById("errorLog");
    const patchRawEl = document.getElementById("patchRaw");
    const patchList = document.getElementById("patchList");
    const search = document.getElementById("search");
    const filter = document.getElementById("filter");
    const fromDate = document.getElementById("fromDate");
    const toDate = document.getElementById("toDate");
    let patches = [];
    let lastDebug = "";
    let lastError = "";
    let lastApiRaw = "";
    let lastPatchRaw = "";

    function formatTime(d) {
      return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    async function fetchData() {
      patchStatus.textContent = "Lade Patch-Daten von EA...";
      lastError = "";
      try {
        const res = await fetch("/api/groq2", { method: "POST" });
        const data = await res.json();
        datetime.textContent = formatTime(new Date());
        lastApiRaw = JSON.stringify(data, null, 2);
        apiRawEl.textContent = lastApiRaw;

        // Versuche m√∂glichst viele Debuginfos zu zeigen
        lastDebug = data.debug ? JSON.stringify(data.debug, null, 2) : "";
        debugEl.textContent = lastDebug || "Keine Debug-Infos.";
        lastPatchRaw = data.content ? (
            data.content.length > 1400
                ? data.content.slice(0, 1400) + "\n...\n[gekuerzt]" 
                : data.content
          ) : "‚Äî";
        patchRawEl.textContent = lastPatchRaw;

        let jsonPatches = [];
        try {
          jsonPatches = JSON.parse(data.content).patches || [];
        } catch(e) {
          lastError += "\nPatchdaten konnten nicht geparst werden: " + e.toString();
        }
        if (jsonPatches.length) {
          patches = jsonPatches;
          patchStatus.innerHTML = `<span class="good">Gefundene Patches: ${patches.length}</span>`;
        } else {
          patches = [];
          patchStatus.innerHTML = `<span class="bad">Keine Patches gefunden</span>`;
        }
        render();
      } catch (e) {
        lastError += "\nFetch/API Fehler: " + e.toString();
        patchStatus.innerHTML = `<span class="bad">Fehler beim Laden der Patch-Daten!</span>`;
      }
      errorLogEl.textContent = lastError || "Keine Fehler.";
    }

    function filterPatches() {
      let out = patches;
      if (search.value) {
        const q = search.value.toLowerCase();
        out = out.filter(p =>
          (p.version && p.version.toLowerCase().includes(q)) ||
          (p.weapon && p.weapon.toLowerCase().includes(q)) ||
          (p.notes && p.notes.toLowerCase().includes(q))
        );
      }
      if (filter.value) {
        out = out.filter(p => (filter.value === "Buffs" ? p.buff : p.nerf));
      }
      if (fromDate.value) {
        out = out.filter(p => p.date >= fromDate.value);
      }
      if (toDate.value) {
        out = out.filter(p => p.date <= toDate.value);
      }
      return out;
    }

    function render() {
      const filtered = filterPatches();
      patchList.innerHTML = "";
      if (!filtered.length) {
        patchList.innerHTML = `<span class="muted">Noch keine Patch-Daten geladen oder keine passenden Patches gefunden.</span>`;
        return;
      }
      filtered.forEach(p => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = [
          `<b>${p.version || ""}</b>`,
          p.date ? `<span>${p.date}</span>` : "",
          p.weapon ? "Waffe: " + p.weapon + " " : "",
          p.buff ? '<span class="good">Buff</span>' : "",
          p.nerf ? '<span class="bad">Nerf</span>' : "",
          `<br>${p.notes || ""}`
        ].join(' ');
        patchList.appendChild(chip);
      });
    }

    reloadBtn.addEventListener("click", fetchData);
    search.addEventListener("input", render);
    filter.addEventListener("change", render);
    fromDate.addEventListener("change", render);
    toDate.addEventListener("change", render);

    fetchData();
    setInterval(fetchData, 60 * 60 * 1000); // 60 Minuten
  </script>
</body>
</html>
