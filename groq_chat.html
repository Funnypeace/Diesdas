<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Groq Chat – Elegant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .bubble { border-radius: 1.25rem; }
    .spinner { width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-white to-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-4 md:p-6 lg:p-8">
    <!-- Header -->
    <header class="mb-4 md:mb-6 flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-semibold">G</div>
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Groq Chat</h1>
    </header>

    <!-- Hidden fixed model -->
    <input type="hidden" id="model" value="llama-3.3-70b-versatile">

    <!-- Controls (nur Temperatur und Max Tokens) -->
    <section class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <label class="flex flex-col gap-1">
        <span class="text-sm text-slate-500">
          Temperatur <span id="tempVal" class="font-mono">0.2</span>
          <span class="block text-[11px] text-slate-400 font-normal">0 = sehr präzise/deterministisch · 1 = sehr kreativ/zufällig</span>
        </span>
        <input id="temperature" type="range" min="0" max="1" step="0.1" value="0.2" class="w-full" />
      </label>
      <label class="flex flex-col gap-1">
        <span class="text-sm text-slate-500">Max Tokens</span>
        <input id="maxTokens" type="number" min="1" max="4096" value="1024" class="px-3 py-2 rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-400" />
      </label>
    </section>

    <!-- Chat area -->
    <main id="chat" class="h-[60vh] md:h-[65vh] overflow-y-auto rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm p-4 flex flex-col gap-3">
      <div class="self-start bubble bg-slate-100 px-4 py-3">
        <div class="text-xs text-slate-500 mb-1">Assistant</div>
        <div>Hi! Stell mir eine Frage – ich antworte mit dem festen Groq‑Modell <code>llama-3.3-70b-versatile</code>.</div>
      </div>
    </main>

    <!-- Composer -->
    <form id="composer" class="mt-3 flex items-end gap-2">
      <textarea id="input" rows="1" placeholder="Schreibe deine Nachricht… (Strg/Cmd+Enter = Senden, Shift+Enter = Zeilenumbruch)" class="flex-1 px-4 py-3 rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-400 resize-none"></textarea>
      <button id="send" type="submit" class="px-4 py-3 rounded-2xl bg-slate-900 text-white shadow-sm hover:bg-slate-800 active:bg-slate-900 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
        <span>Senden</span>
        <div id="loading" class="spinner hidden"></div>
      </button>
    </form>
  </div>

  <script>
    "use strict";

    const chat = document.getElementById("chat");
    const form = document.getElementById("composer");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const loading = document.getElementById("loading");
    const modelEl = document.getElementById("model");
    const tempEl = document.getElementById("temperature");
    const tempVal = document.getElementById("tempVal");
    const maxTokensEl = document.getElementById("maxTokens");

    tempEl.addEventListener("input", () => (tempVal.textContent = (+tempEl.value).toFixed(1)));

    // Auto-resize textarea
    input.addEventListener("input", () => {
      input.style.height = "auto";
      input.style.height = Math.min(input.scrollHeight, 200) + "px";
    });

    // Keyboard shortcuts
    input.addEventListener("keydown", (e) => {
      if ((e.key === "Enter" && (e.ctrlKey || e.metaKey))) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const content = input.value.trim();
      if (!content) return;
      input.value = ""; input.dispatchEvent(new Event("input"));

      const userBubble = makeBubble(true, content);
      chat.appendChild(userBubble);
      chat.scrollTop = chat.scrollHeight;

      const assistantBubble = makeBubble(false, "…");
      chat.appendChild(assistantBubble);
      chat.scrollTop = chat.scrollHeight;

      setLoading(true);

      try {
        const resp = await fetch("/api/groq", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: modelEl.value,
            messages: [
              { role: "system", content: "Du bist ein hilfreicher, präziser KI-Assistent." },
              { role: "user", content }
            ],
            temperature: Number(tempEl.value),
            max_tokens: Number(maxTokensEl.value),
            stream: false,
            action: "chat"
          }),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`HTTP ${resp.status} – ${text}`);
        }

        const data = await resp.json();
        const text = data?.content || data?.choices?.[0]?.message?.content || "(keine Antwort)";
        assistantBubble.querySelector(".content").textContent = text;
      } catch (err) {
        assistantBubble.querySelector(".content").innerHTML = `<span class="text-red-600">Fehler: ${escapeHtml(String(err.message || err))}</span>`;
      } finally {
        setLoading(false);
      }
    });

    function setLoading(is) {
      sendBtn.disabled = is;
      loading.classList.toggle("hidden", !is);
    }

    function makeBubble(isUser, text) {
      const wrap = document.createElement("div");
      wrap.className = `${isUser ? "self-end bg-slate-900 text-white" : "self-start bg-slate-100"} bubble px-4 py-3 max-w-[85%]`;
      wrap.innerHTML = `
        <div class="flex items-center gap-2 mb-1">
          <div class="w-6 h-6 rounded-full ${isUser ? "bg-slate-800" : "bg-slate-200"} grid place-items-center text-[10px]">${isUser ? "DU" : "AI"}</div>
          <div class="text-xs ${isUser ? "text-slate-300" : "text-slate-500"}">${isUser ? "Du" : "Assistant"}</div>
          <button class="ml-auto text-xs opacity-60 hover:opacity-100 underline copy">Kopieren</button>
        </div>
        <div class="content whitespace-pre-wrap break-words"></div>
      `;
      wrap.querySelector(".content").textContent = text;
      wrap.querySelector(".copy").addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(wrap.querySelector(".content").textContent || "");
        } catch {}
      });
      return wrap;
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      })[c]);
    }
  </script>
</body>
</html>
