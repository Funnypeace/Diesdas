<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>GROQ Chat Debug</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    #antwort { white-space: pre-line; border: 1px solid #aaa; background: #fafafa; padding: 1em; margin-top: 1em; }
    button { padding: 6px 20px; }
    input[type="text"] { padding: 6px; width: 400px; }
    #debug { font-size: 0.9em; color: #444; margin-top: 1em; white-space: pre; background: #f0f0f0; border: 1px dashed #aaa; padding: 10px; }
    .info { color: #058; font-size: 0.94em; margin-bottom: 1em; }
    label { font-weight: 600; }
  </style>
</head>
<body>
  <h2>🧠 GROQ API Debug Chat</h2>
  <div class="info">
    Diese Version zeigt **ALLE Fehler und Debug-Infos** an.<br>
    Endpoint: <code>/api/groq2</code><br>
    Wenn etwas nicht funktioniert, erscheinen detaillierte Infos im Debug-Bereich.
  </div>

  <label for="frage">Deine Frage:</label><br>
  <input type="text" id="frage" placeholder="z. B. Was sind die News heute?">
  <button onclick="frageAbsenden()">Absenden</button>

  <div id="antwort"></div>
  <div id="debug"></div>

  <script>
    async function frageAbsenden() {
      const frage = document.getElementById('frage').value.trim();
      const antwortEl = document.getElementById('antwort');
      const debugEl = document.getElementById('debug');
      antwortEl.textContent = '⏳ Anfrage läuft...';
      debugEl.textContent = '';

      if (!frage) {
        antwortEl.textContent = '❗ Bitte gib eine Frage ein!';
        return;
      }

      try {
        const start = performance.now();
        const res = await fetch('/api/groq2', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'chat',
            messages: [{ role: 'user', content: frage }],
            model: 'llama-3.3-70b-versatile'
          })
        });

        const duration = (performance.now() - start).toFixed(0);
        let rawText;
        try {
          rawText = await res.clone().text();
        } catch (e) {
          rawText = '⚠️ Response konnte nicht gelesen werden: ' + e.message;
        }

        let json;
        try {
          json = JSON.parse(rawText);
        } catch (e) {
          json = null;
        }

        // --- HTTP Fehlerbehandlung ---
        if (!res.ok) {
          antwortEl.textContent = `❌ HTTP Fehler ${res.status}: ${res.statusText}`;
          debugEl.textContent = `Response Body (Text):\n${rawText}`;
          return;
        }

        // --- JSON Parsing Ergebnis ---
        if (!json) {
          antwortEl.textContent = '❌ Fehler: Antwort ist kein gültiges JSON!';
          debugEl.textContent = rawText;
          return;
        }

        // --- Inhalt prüfen ---
        if (json.error) {
          antwortEl.textContent = `⚠️ API Fehler: ${json.error}\n${json.details || ''}`;
        } else if (json.content) {
          antwortEl.textContent = `✅ Antwort (${duration} ms):\n\n${json.content}`;
        } else {
          antwortEl.textContent = '⚠️ Unerwartetes Format ohne "content"';
        }

        debugEl.textContent = JSON.stringify(json, null, 2);
      } catch (err) {
        antwortEl.textContent = '💥 Ausnahmefehler: ' + err.message;
        debugEl.textContent = err.stack || '(keine Stacktrace)';
      }
    }

    document.getElementById('frage').addEventListener('keypress', e => {
      if (e.key === 'Enter') frageAbsenden();
    });
  </script>
</body>
</html>
