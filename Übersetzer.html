<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mehrsprachiger √úbersetzer ¬∑ Groq ‚ü∑ Vercel</title>
  <meta name="description" content="Einseiten-√úbersetzer: sendet an /api/groq(.js) und liefert mehrere Sprachen zugleich." />
  <style>
    :root { --bg:#0b0c10; --panel:#12141a; --soft:#171a22; --text:#e7e9ee; --muted:#a6acb8; --acc:#5aa2ff; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; }
    [data-theme="light"] { --bg:#f6f7fb; --panel:#ffffff; --soft:#eef1f6; --text:#16181d; --muted:#4d5461; --acc:#2f6bff; --ok:#16a34a; --warn:#b7791f; --danger:#dc2626; }
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .app{display:grid; grid-template-rows:auto 1fr auto; height:100%}
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));}
    .bar{display:flex; gap:10px; align-items:center; padding:14px 16px}
    .brand{font-weight:800; letter-spacing:.2px}
    .pill{font-size:12px; color:var(--muted); background:var(--soft); border:1px solid rgba(255,255,255,.08); padding:4px 8px; border-radius:999px}
    .sp{flex:1}
    .btn{background:var(--panel); color:var(--text); border:1px solid rgba(255,255,255,.08); padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    main{max-width:1060px; margin:0 auto; width:100%; padding:0 14px 100px; display:grid; gap:14px}
    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:14px}
    @media (max-width: 880px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px}
    .card h3{margin:0 0 10px 0; font-size:16px}
    textarea{min-height:160px; resize:vertical; width:100%; box-sizing:border-box; padding:12px; background:var(--soft); border:1px solid rgba(255,255,255,.12); color:var(--text); border-radius:12px}
    textarea:focus{outline:none; border-color:var(--acc)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .hint{font-size:12px; color:var(--muted)}
    .lang-list{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px}
    @media (max-width:640px){ .lang-list{grid-template-columns:1fr} }
    .lang{display:flex; align-items:center; gap:8px; background:var(--soft); border:1px solid rgba(255,255,255,.08); padding:8px; border-radius:12px}
    .lang input{transform:translateY(1px)}
    .lang .code{font-size:11px; color:var(--muted); margin-left:auto}
    .actions{display:flex; gap:10px; align-items:center}
    .primary{background:var(--acc); color:white; border:none}
    .result-grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px}
    @media (max-width:900px){ .result-grid{grid-template-columns:1fr} }
    .res{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; position:relative}
    .res h4{margin:0 0 6px 0}
    .tools{position:absolute; right:8px; top:8px; display:flex; gap:6px}
    .tool{font-size:12px; padding:4px 8px; background:var(--soft); border:1px solid rgba(255,255,255,.1); border-radius:8px; cursor:pointer}
    .tool:hover{border-color:rgba(255,255,255,.18)}
    pre, code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New",monospace}
    pre{white-space:pre-wrap; word-wrap:break-word; background:var(--soft); border:1px solid rgba(255,255,255,.08); padding:10px; border-radius:10px; margin:0}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono"; background:var(--soft); border:1px solid rgba(255,255,255,.1); border-radius:6px; padding:0 6px; font-size:12px}
    footer{position:fixed; bottom:0; left:0; right:0; background:linear-gradient(0deg, var(--bg), transparent)}
    footer .bar{padding:10px 16px}
    .sep{height:1px; background:rgba(255,255,255,.08); margin:10px -14px 0}
    .tag{font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted)}
    .status{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
<div class="app" data-theme="dark" id="app">
  <header>
    <div class="bar">
      <div class="brand">Mehrsprachiger √úbersetzer</div>
      <span class="pill">Groq ‚ü∑ Vercel API</span>
      <span class="sp"></span>
      <span class="status" id="status">Bereit</span>
      <button class="btn" id="themeBtn" title="Theme umschalten">üåì</button>
      <button class="btn" id="exportBtn" title="Ergebnisse als JSON speichern">‚¨áÔ∏è Export</button>
      <button class="btn" id="clearBtn" title="Ergebnisse leeren">üóëÔ∏è Leeren</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <div class="card">
        <h3>Quelltext</h3>
        <textarea id="source" placeholder="Text hier einf√ºgen‚Ä¶"></textarea>
        <div class="row" style="margin-top:10px">
          <input type="url" id="apiUrl" placeholder="/api/groq oder /api/groq.js" style="flex:1; padding:8px 10px; background:var(--soft); border:1px solid rgba(255,255,255,.12); color:var(--text); border-radius:10px" />
          <button class="btn" id="testBtn">Verbindung testen</button>
        </div>
        <div class="hint" style="margin-top:6px">Die Server-Route liegt in deinem Projekt unter <code>/api/groq.js</code>. Leer lassen nutzt automatisch <span class="tag">/api/groq</span> (Fallback auf <span class="tag">/api/groq.js</span> bei 404).</div>
      </div>

      <div class="card">
        <h3>Zielsprachen</h3>
        <div class="lang-list" id="langList"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="selectAll">Alle</button>
          <button class="btn" id="selectNone">Keine</button>
          <span class="sp"></span>
          <span class="hint">Tipp: <span class="kbd">Ctrl/Cmd</span> + <span class="kbd">Enter</span> sendet sofort.</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row actions">
          <button class="btn primary" id="translateBtn">√úbersetzen ‚ñ∂</button>
          <label class="row" style="gap:6px"><input type="checkbox" id="keepFormatting" checked> Formatierung beibehalten</label>
          <label class="row" style="gap:6px"><input type="checkbox" id="ttsEnable"> Vorlesen aktivieren</label>
        </div>
        <div class="row"><span class="hint">API: <span class="tag" id="apiVis">/api/groq</span></span></div>
      </div>
      <div class="sep"></div>
      <div id="results" class="result-grid" style="margin-top:12px"></div>
      <details style="margin-top:12px">
        <summary>Debug</summary>
        <pre id="debugOut">‚Äî</pre>
      </details>
    </div>
  </main>

  <footer>
    <div class="bar">
      <span class="hint">Erstellt als Single‚ÄëFile Client. Erkennt Quellsprache automatisch und liefert mehrere Zielsprachen in einem Request.</span>
      <span class="sp"></span>
      <span class="hint">Action: <span class="tag">chat</span> ¬∑ Body: <code>{ messages: [...], action: "chat" }</code></span>
    </div>
  </footer>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const app = $('#app');
  const source = $('#source');
  const translateBtn = $('#translateBtn');
  const apiUrl = $('#apiUrl');
  const apiVis = $('#apiVis');
  const results = $('#results');
  const debugOut = $('#debugOut');
  const selectAllBtn = $('#selectAll');
  const selectNoneBtn = $('#selectNone');
  const themeBtn = $('#themeBtn');
  const exportBtn = $('#exportBtn');
  const clearBtn = $('#clearBtn');
  const testBtn = $('#testBtn');
  const keepFormatting = $('#keepFormatting');
  const ttsEnable = $('#ttsEnable');
  const status = $('#status');

  const LS = { THEME:'tx.theme', LANGS:'tx.langs', API:'tx.api', KEEP:'tx.keepFmt', TTS:'tx.tts' };

  const ALL_LANGS = [
    { code:'en', name:'Englisch' },
    { code:'es', name:'Spanisch' },
    { code:'fr', name:'Franz√∂sisch' },
    { code:'pt', name:'Portugiesisch' },
    { code:'it', name:'Italienisch' },
    { code:'nl', name:'Niederl√§ndisch' },
    { code:'pl', name:'Polnisch' },
    { code:'tr', name:'T√ºrkisch' },
    { code:'ru', name:'Russisch' },
    { code:'ja', name:'Japanisch' },
    { code:'zh', name:'Chinesisch (vereinfacht)' },
    { code:'ar', name:'Arabisch' },
    { code:'hi', name:'Hindi' },
    { code:'sv', name:'Schwedisch' },
    { code:'no', name:'Norwegisch' },
    { code:'da', name:'D√§nisch' },
    { code:'fi', name:'Finnisch' }
  ];

  function load(k,f){ try{ return JSON.parse(localStorage.getItem(k)) ?? f }catch{return f} }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

  // Theme
  function setTheme(t){ app.setAttribute('data-theme', t); localStorage.setItem(LS.THEME, t) }
  setTheme(localStorage.getItem(LS.THEME)||'dark');
  themeBtn.addEventListener('click', ()=> setTheme(app.getAttribute('data-theme')==='dark'?'light':'dark'));

  // Populate language list
  const langList = $('#langList');
  const savedLangs = load(LS.LANGS, ['en','es','fr','pt']);
  ALL_LANGS.forEach(l => {
    const row = document.createElement('label');
    row.className = 'lang';
    const cb = document.createElement('input');
    cb.type='checkbox';
    cb.value=l.code;
    cb.checked = savedLangs.includes(l.code);
    cb.addEventListener('change', persistLangs);
    const span = document.createElement('span'); span.textContent = l.name;
    const code = document.createElement('span'); code.className='code'; code.textContent = l.code;
    row.append(cb, span, code);
    langList.appendChild(row);
  });
  function selectedLangs(){ return [...langList.querySelectorAll('input[type="checkbox"]')].filter(x=>x.checked).map(x=>x.value) }
  function persistLangs(){ save(LS.LANGS, selectedLangs()); }
  selectAllBtn.addEventListener('click', ()=>{ langList.querySelectorAll('input').forEach(i=>i.checked=true); persistLangs(); });
  selectNoneBtn.addEventListener('click', ()=>{ langList.querySelectorAll('input').forEach(i=>i.checked=false); persistLangs(); });

  // Inputs init
  apiUrl.value = load(LS.API, '');
  apiVis.textContent = apiUrl.value || '/api/groq';
  apiUrl.addEventListener('input', ()=>{ save(LS.API, apiUrl.value); apiVis.textContent = apiUrl.value || '/api/groq'; });
  keepFormatting.checked = load(LS.KEEP, true); keepFormatting.addEventListener('change', ()=> save(LS.KEEP, keepFormatting.checked));
  ttsEnable.checked = load(LS.TTS, false); ttsEnable.addEventListener('change', ()=> save(LS.TTS, ttsEnable.checked));

  // Keyboard shortcut
  document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); translate(); } });

  // Buttons
  translateBtn.addEventListener('click', translate);
  clearBtn.addEventListener('click', ()=>{ results.innerHTML=''; debugOut.textContent='‚Äî'; status.textContent='Bereit'; });
  exportBtn.addEventListener('click', ()=>{
    const payload = { source: source.value, results: collectResults() };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='translations.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });
  testBtn.addEventListener('click', testConnection);

  function getApi(){ return (apiUrl.value || '/api/groq').replace(/\/$/, '') }

  async function testConnection(){
    const body = { messages:[{role:'system', content:'Return exactly: OK'},{role:'user', content:'Say only OK.'}], action:'chat' };
    setBusy(true, 'Teste Verbindung‚Ä¶');
    try{
      const data = await callApi(body);
      debugOut.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
      alert('Antwort erhalten. Siehe Debug unten.');
    }catch(e){ alert('Fehler: '+ (e.message||e)); }
    finally{ setBusy(false) }
  }

  function setBusy(on, msg='Sendet‚Ä¶'){
    translateBtn.disabled = on; testBtn.disabled = on; source.disabled = on; status.textContent = on? msg : 'Bereit';
    translateBtn.textContent = on? 'Sendet‚Ä¶' : '√úbersetzen ‚ñ∂';
  }

  function languageMeta(code){ return ALL_LANGS.find(l=>l.code===code) || { code, name: code } }

  function buildMessages(text, codes){
    const targets = codes.map(c=>languageMeta(c));
    const system = `You are a professional translation engine. Detect the source language. Translate the user's input into the requested target languages. Return ONLY a raw JSON array, no code fences, with items: {"languageCode": string, "languageName": string, "text": string}. Preserve tone, emojis, punctuation, and (if present) Markdown formatting. Keep URLs and code blocks unchanged; translate only natural-language commentary. Do not add any explanations or headings.`;
    const user = JSON.stringify({ sourceText: text, targets, keepFormatting: !!keepFormatting.checked });
    return [ { role:'system', content: system }, { role:'user', content: user } ];
  }

  function extractContent(payload){
    if(typeof payload === 'string') return payload;
    if(payload?.content) return payload.content;
    if(payload?.message?.content) return payload.message.content;
    if(Array.isArray(payload?.choices) && payload.choices[0]?.message?.content) return payload.choices[0].message.content;
    if(payload?.result) return payload.result;
    if(payload?.assistant) return payload.assistant;
    if(payload?.output) return payload.output;
    return JSON.stringify(payload);
  }

  function tryParseJSON(text){
    // Try fenced block first
    const m = text.match(/```json\s*([\s\S]*?)```/i) || text.match(/```\s*([\s\S]*?)```/);
    const raw = m ? m[1] : text;
    try { return JSON.parse(raw) } catch { return null }
  }

  async function translate(){
    const text = source.value.trim();
    const codes = selectedLangs();
    if(!text){ alert('Bitte Quelltext eingeben.'); return }
    if(codes.length===0){ alert('Mindestens eine Zielsprache w√§hlen.'); return }

    setBusy(true);
    results.innerHTML = '';
    debugOut.textContent = '‚Äî';

    const body = { messages: buildMessages(text, codes), action:'chat' };

    try{
      const data = await callApi(body);
      const content = extractContent(data);
      debugOut.textContent = typeof data==='string' ? data : (JSON.stringify(data, null, 2));

      let arr = tryParseJSON(content);
      if(!Array.isArray(arr)){
        // Fallback: create an array with a single generic item
        arr = codes.map(c=>({ languageCode:c, languageName: languageMeta(c).name, text: content }));
      }

      renderResults(arr);
      setBusy(false, 'Fertig');
    }catch(err){
      setBusy(false);
      debugOut.textContent = String(err?.stack || err?.message || err);
      alert('Fehler: ' + (err?.message || err));
    }
  }

  function renderResults(items){
    results.innerHTML = '';
    items.forEach(item=>{
      const wrap = document.createElement('div'); wrap.className='res';
      const h = document.createElement('h4'); h.textContent = `${item.languageName||item.languageCode}`;
      const tools = document.createElement('div'); tools.className='tools';
      const copyBtn = document.createElement('button'); copyBtn.className='tool'; copyBtn.textContent='Kopieren'; copyBtn.onclick=()=>navigator.clipboard.writeText(item.text||'');
      const speakBtn = document.createElement('button'); speakBtn.className='tool'; speakBtn.textContent='Vorlesen'; speakBtn.title='Web Speech API';
      speakBtn.onclick=()=>{
        if(!ttsEnable.checked){ alert('Vorlesen ist deaktiviert. H√§kchen bei "Vorlesen aktivieren" setzen.'); return }
        try{
          const u = new SpeechSynthesisUtterance(item.text||'');
          // Try set language hint (may be ignored by browser)
          u.lang = (item.languageCode||'').toLowerCase();
          speechSynthesis.speak(u);
        }catch(e){ alert('TTS nicht verf√ºgbar: '+ e.message) }
      }
      tools.append(copyBtn, speakBtn);

      const pre = document.createElement('pre'); pre.textContent = item.text || '';
      wrap.append(h, tools, pre);
      results.appendChild(wrap);
    });
  }

  function collectResults(){
    const out = [];
    results.querySelectorAll('.res').forEach(card=>{
      const title = card.querySelector('h4')?.textContent || '';
      const text = card.querySelector('pre')?.textContent || '';
      const meta = ALL_LANGS.find(l=>l.name===title) || { name:title, code:title };
      out.push({ languageName: meta.name, languageCode: meta.code, text });
    });
    return out;
  }

  async function callApi(body){
    const primary = getApi();
    try{
      const r = await fetch(primary, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(r.status===404 && !/\.js$/.test(primary)){
        // Retry with .js suffix
        const fallback = primary + '.js';
        const r2 = await fetch(fallback, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const t2 = await r2.text();
        return parseMaybeJSON(t2);
      }
      const t = await r.text();
      return parseMaybeJSON(t);
    }catch(e){ throw e }
  }

  function parseMaybeJSON(text){
    try{ return JSON.parse(text) } catch{ return text }
  }

})();
</script>
</body>
</html>
